# Efficiency24 ROI Calculator (Cloudflare Worker Version)

Web-based ROI calculator for Argentine SMEs considering Bitrix24 CRM + chatbot, deployed as a Cloudflare Worker. The Worker serves the static React frontend and provides a secure backend API endpoint for interacting with the Google Gemini API.

## Prerequisites

*   Node.js and npm (or yarn/pnpm) installed.
*   A Cloudflare account.
*   Wrangler CLI installed (`npm install -g wrangler` or add as a dev dependency).

## Project Structure

*   `public/`: Contains the client-side React application source files (`index.html`, `index.tsx`, `App.tsx`, components, etc.).
*   `worker/`: Contains the Cloudflare Worker script (`worker.ts`).
*   `dist/`: Contains the built output: compiled worker (`index.js`), client bundle (`bundle.js`), and `index.html`. This directory is generated by the build process.
*   `wrangler.toml`: Configuration for the Cloudflare Worker.
*   `package.json`: Project dependencies and scripts.
*   `tsconfig.json`: TypeScript configuration for both client and worker.

## Setup

1.  **Clone/Download Files:**
    Ensure you have all the project files.

2.  **Install Dependencies:**
    ```bash
    npm install
    ```

3.  **Configure `wrangler.toml`:**
    *   Open `wrangler.toml`.
    *   Set your Cloudflare `account_id` if it's not configured globally via Wrangler login.
    *   The `name` of the worker can be customized.
    *   The `main` field is set to `dist/index.js`.
    *   The `[site].bucket` is set to `./dist`, which is where your static frontend assets (including `bundle.js` and `index.html` after build) will be served from by `kv-asset-handler`.
    *   The `[build].command` is set to `npm run build`, which compiles both your worker and client-side code into the `./dist` directory.

4.  **API Key Management:**
    The Google Gemini API key is handled securely by the Cloudflare Worker.
    *   **For Production Deployment:** Set the `API_KEY` as a secret in your Worker's settings via the Cloudflare dashboard or Wrangler CLI:
        ```bash
        npx wrangler secret put API_KEY
        ```
        You will be prompted to enter your API key.
    *   **For Local Development (`wrangler dev`):** Create a `.dev.vars` file in the project root:
        ```
        API_KEY="YOUR_GEMINI_API_KEY_FOR_LOCAL_DEV"
        ```
        **Important:** Add `.dev.vars` to your `.gitignore` file to prevent committing your API key.

## Available Scripts

*   **`npm run build`**: Cleans the `dist` directory, then compiles the Worker script (`worker/worker.ts` to `dist/index.js`), the client-side application (`public/index.tsx` to `dist/bundle.js`), and copies `public/index.html` to `dist/index.html`.
*   **`npm run dev`**: Starts the local development server using Wrangler. This will execute the `npm run build` command defined in `wrangler.toml` and watch for changes.
*   **`npm run deploy`**: Builds the project (using `npm run build` via `wrangler.toml`) and deploys the Worker and static assets from the `dist` directory to Cloudflare.
*   **`npm run start`**: Alias for `npm run dev`.

## Local Development

1.  Ensure you have a `.dev.vars` file with your `API_KEY` as described above.
2.  Run:
    ```bash
    npm run dev
    ```
    Wrangler will start a local server (typically `http://localhost:8787`), build your project, and serve your application. The `watch_dir` setting in `wrangler.toml` will trigger rebuilds on file changes in `public` or `worker` directories.

## Deployment to Cloudflare

1.  Ensure `wrangler.toml` is correctly configured and you have set the `API_KEY` secret in your Cloudflare Worker settings.
2.  Run:
    ```bash
    npm run deploy
    ```
    Wrangler will build your project (as specified by `[build].command` in `wrangler.toml`) and then deploy your Worker script and the contents of the `dist` directory to Cloudflare.

## How It Works

*   **Client-Side Application (Source: `public/`, Build Output: `dist/`):**
    *   A React application built with TypeScript/TSX.
    *   User inputs data into the ROI calculator form.
    *   When "Calcular y Ver Resultados" is clicked, the app sends the input data and calculated values via a `fetch` POST request to the `/api/prepare-email` endpoint provided by its own Cloudflare Worker.
    *   Displays the results based on calculations and the (simulated) data preparation confirmation.
*   **Cloudflare Worker (Source: `worker/worker.ts`, Build Output: `dist/index.js`):**
    *   **API Endpoint (`/api/prepare-email`):**
        *   Receives data from the client application.
        *   Securely initializes the `GoogleGenAI` client using the `API_KEY` from Worker secrets.
        *   Constructs a prompt and calls the Gemini API to generate an email body.
        *   Returns the generated email body (or an error) to the client.
    *   **Static Asset Serving:**
        *   For all other requests, it uses `@cloudflare/kv-asset-handler` to serve static files (like `index.html`, `bundle.js`, images, etc.) from the `dist` directory. This directory's contents are uploaded by Wrangler due to the `[site].bucket = "./dist"` configuration.
        *   It's configured to serve `index.html` for root path (`/`) and for SPA-style routing (unknown paths without file extensions).
*   **Build Process (`npm run build`):**
    *   `rimraf ./dist`: Cleans the output directory.
    *   `esbuild` (via `npm run build:worker`) compiles `worker/worker.ts` into `dist/index.js`.
    *   `esbuild` (via `npm run build:client`) compiles `public/index.tsx` and all its imported React components and modules into `dist/bundle.js`.
    *   `node -e "..."` (via `npm run copy:html`) copies `public/index.html` to `dist/index.html`.
    *   All output is placed in the `dist` directory, ready for Wrangler to deploy.
